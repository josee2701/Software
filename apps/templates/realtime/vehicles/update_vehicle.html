{% load i18n static %}

{% block content %}
{{form.media}}
<div class="modal-content" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-body">
        <div class="card">
            <div class="modal-header">
                <h3>{% trans "Update Vehicle" %}</h3>
                <button type="button" id="cerrarVenta" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form hx-post="{{ request.path }}" enctype="multipart/form-data">
                <div class="card-body scrollable-content" id="dynamic-scrollable-content1"style="overflow-y: auto;">
                    
                        {% csrf_token %}
                        <input type="hidden" id="id_vehicle" value="{{ vehicle.id }}">
                        <div class="row">
                            <div class="col">
                                <p></p>
                                <div class="input-group input-group-static mb-4">
                                    <label for="id_plate">{% trans "Plate :" %} <span style="color:red;">*</span> </label>
                                    {{form.license}}
                                </div>
                                <div class="text-danger">{{ form.license.errors }}</div>
                            </div>
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_owner">{% trans "Owner" %}</label>
                                        {{form.owner}}
                                    </div>
                                </p>
                            </div>
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_insurance">{% trans "Insurance" %}</label>
                                        {{form.insurance}}
                                    </div>
                                </p>
                            </div>
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_vehicle_type">{% trans "Asset type" %}<span style="color:red;"> *</span></label>
                                        {{form.vehicle_type}}
                                    </div>
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_company">{% trans "Company" %}<span style="color:red;"> *</span></label>
                                        {{form.company}}
                                    </div>
                                    <div id="form-errors">
                                        {{form.company.errors}}
                                    </div>
                                </p>
                            </div>
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_device">{% trans "Device / Imei" %}<span style="color:red;"> *</span></label>
                                        {{form.device}}
                                    </div>
                                </p>
                            </div>
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_fuel_type">{% trans 'Fuel type' %}<span style="color:red;"> *</span></label>
                                        {{form.fuel_type}}
                                    </div>
                                </p>
                            </div>
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_n_interno">{% trans 'N° internal' %}<span style="color:red;"> *</span></label>
                                        {{form.n_interno}}
                                    </div>
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="input-group input-group-static mb-4">
                                    <label for="id_cylinder_capacity">{% trans 'Cylinder capacity' %}</label>
                                    {{form.cylinder_capacity}}
                                </div>
                            </div>
                            <div class="col">
                                <div class="input-group input-group-static mb-4">
                                    <label for="id_km_per_gallon">{% trans 'Km per gallon' %}</label>
                                    {{form.km_per_gallon}}
                                </div>
                            </div>
                            <div class="col">
                                <div class="input-group input-group-static mb-4">
                                    <label for="id_max_speed_allowed">{% trans 'Max speed allowed' %}</label>
                                    {{form.max_speed_allowed}}
                                </div>
                            </div>
                            <div class="col">
                                <div class="input-group input-group-static mb-4">
                                    <label for="id_fuel_tank_capacity">{% trans 'Fuel tank capacity in gallons' %}</label>
                                    {{form.fuel_tank_capacity}}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_brand">{% trans "Brand" %}</label>
                                        {{form.brand}}
                                    </div>
                                </p>
                            </div>
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_model">{% trans "Model" %}</label>
                                        {{form.model}}
                                    </div>
                                </p>
                            </div>
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_line">{% trans 'Line' %}</label>
                                        {{form.line}}
                                    </div>                                    
                                </p>
                            </div>
                            <div class="col">
                                <p>
                                    <div class="input-group input-group-static mb-4">
                                        <label for="id_color">{% trans 'Color' %}</label>
                                        {{form.color}}
                                    </div>                                    
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="input-group input-group-static mb-4">
                                    <label for="id_engine_serial">{% trans 'Engine serial' %}</label>
                                    {{form.engine_serial}}
                                </div>
                            </div>
                            <div class="col">
                                <div class="input-group input-group-static mb-4">
                                    <label for="id_chassis">{% trans 'Chassis' %}</label>
                                    {{form.chassis}}
                                </div>                                
                            </div>
                            <div class="col">
                                <div class="input-group input-group-static mb-4">
                                    <label for="id_capacity">{% trans ' Capacity' %}</label>
                                    {{form.capacity}}
                                </div>
                            </div>
                            <div class="col">
                                <div class="input-group input-group-static mb-4">
                                    <label for="id_alias">{% trans "Alias" %}</label>
                                    {{form.alias}}
                                </div>                                
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="form-check form-switch mb-3" style="padding-block-start: 18px;">
                                    <label for="id_is_active" class="form-check-label"> {% trans "Is active?" %}<span style="color:red;"> *</span> </label>
                                    {{form.is_active}}
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch mb-3" style="padding-block-start: 18px;">
                                    <label for="id_remote_shutdown">{% trans 'Remote shutdown' %}</label>
                                    {{form.remote_shutdown}}
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch mb-3" style="padding-block-start: 18px;">
                                    <label for="id_microphone"> {% trans 'Microphone' %} </label>
                                    {{form.microphone}}
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch mb-3" style="padding-block-start: 18px;">
                                    <label for="id_camara">{% trans 'Camara' %}:</label>
                                    {{form.camara}}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="contbox_icon radioSelected">
                                <label for="id_icon">Icon <span style="color:red;"> *</span></label>
                                <div id="icon-options">
                                    {% for value, url in form.icon.field.choices %}
                                        <label>
                                            <input type="radio" name="{{ form.icon.name }}" value="{{ value }}"
                                                {% if value == form.initial.icon %} checked {% endif %}>
                                            <img class="myImage" src="{{ value }}" alt="icon">
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col">
                                <div class="input-group input-group-static mb-4" style="width: 150px;">
                                    <label>{% trans 'Installation date' %}<span style="color:red;"> *</span></label>
                                    {{form.installation_date}}
                                </div>
                            </div>
                        </div>
                    </div>
                <div class="row">
                    <div class="col">
                        <button class="btn btn-primary mt-3" type="submit"> <i class="fa-solid fa-floppy-disk me-2"></i> {% trans "Save" %} </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<head>
    <script src="{% static 'assets/js/dynamic-scrollable-content.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/estilos_templates.css' %}">
</head>

<script>
    $(document).ready(function() {
        var deviceSelect = $('#id_device'); // Selector para el select de dispositivos
        var companyId = $('#id_company').val(); // ID de la compañía seleccionada
        var vehicleId = $('#id_vehicle').val(); // ID del vehículo en modo de edición

        function loadDevices(companyId, vehicleId) {
            var endpoint = vehicleId ? `/es/realtime/vehicles/api/available-devices/${companyId}/${vehicleId}/` : `/es/realtime/vehicles/api/available-devices/${companyId}/`;

            fetch(endpoint)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    deviceSelect.empty();
                    var foundCurrent = false;

                    // Primero agregar el dispositivo actualmente asignado como primera opción
                    data.forEach(function(device) {
                        if (vehicleId && !foundCurrent && $('#current_device_id').val() == device.id) {
                            deviceSelect.append(new Option(device.imei, device.id, false, true)); // Añadir y seleccionar
                            foundCurrent = true;
                        } else {
                            deviceSelect.append(new Option(device.imei, device.id));
                        }
                    });

                    if (!foundCurrent && vehicleId) {
                        // Si el dispositivo actual no está en la lista, obtener sus detalles y agregarlo
                        fetch(`/es/realtime/vehicles/device-details/${$('#current_device_id').val()}`) // Asume que tienes una ruta para obtener detalles
                            .then(response => response.json())
                            .then(device => {
                                deviceSelect.prepend(new Option(device.imei, device.id, false, true)); // Añadir al principio y seleccionar
                            });
                    }
                })
                .catch(error => {
                    console.error("Error loading the devices:", error);
                    deviceSelect.append(new Option("Error al cargar dispositivos", ""));
                });
        }

        $('#id_company').change(function() {
            var companyId = $(this).val();
            loadDevices(companyId, vehicleId);
        });

        // Cargar al inicio si estás en modo de edición
        if (companyId && vehicleId) {
            loadDevices(companyId, vehicleId);
        }
        if ($('#id_company').val()) {
            $('#id_company').trigger('change');
        } else {
            $('#id_device').empty().append('<option value="">---------</option>');
        }
    });
</script>
<script>
    document.getElementById('id_model').addEventListener('input', function (e) {
        if (this.value.length > 4) {
            this.value = this.value.slice(0, 4);
        }
    });
</script> 

{% endblock content %}
